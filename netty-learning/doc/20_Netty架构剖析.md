### Netty架构逻辑

* `Reactor`通信调度层
<br>它由一系列辅助类完成，包括`Reactor`线程`NioEventLoop`以及其父类、`NioSocketChannel/NioServerSocketChannel`以及其父类、`ByteBuffer`以及由其衍生出来的各种`Buffer`、`Unsafe`以及其衍生出的各种内部类等。
<br><br>该层的主要职责就是监听网络的读写和连接操作，负责将网络层的数据 读取到内存缓冲区中，然后触发各种网络事件，例如连接创建、连接激活、读事 件、写事件等等，将这些事件触发到`PipeLine`中，由`PipeLine`充当的职责链来进行后续的处理。

* 职责链`PipeLine`
<br>它负责事件在职责链中的有序传播，同时负责动态的 编排职责链，职责链可以选择监听和处理自己关心的事件，它可以拦截处理和向 后/向前传播事件。
<br><br>不同的应用的`Handler`节点的功能也不同，通常情况下，往往会开发编解码`Handler`用于消息的编解码，它可以将外部的协议消息转换成内部的`POJO`对象，这样上层业务侧只需要关心处理业务逻辑即可，不需要感知底层 的协议差异和线程模型差异，实现了架构层面的分层隔离。

* 业务逻辑处理层
<br>它可以分为两类：①纯粹的业务逻辑处理，例如订单处理；②应用层协议管理，例如HTTP协议、FTP协议等。


对于业务开发者，只需要关心职责链的拦截和业务`Handler`的编排。


---
### 关键架构属性

###### 高性能
* 采用异步非阻塞的`I/O`类库，基于`Reactor`模式实现，解决了传统同步阻塞`I/O`模式下服务端无法平滑处理客户端线性增长的问题。
* `TCP`接收和发送缓冲区采用直接内存代替堆内存，避免了内存复制，提升了`I/O`读取和写入性能。
* 支持通过内存池的方式循环利用`ByteBuf`，避免了频繁创建和销毁`ByteBuf`带来的性能消耗。
* 可配置的`I/O`线程数目和`TCP`参数等，为不同用户提供定制化的调优参数，满足不同的性能场景。
* 采用环形数组缓冲区，实现无锁化并发编程，代替传统的线程安全容器或锁。
* 合理使用线程安全容器、原子类等，提升系统的并发能力。
* 关键资源的处理使用采用单线程串行化的方式，避免多线程并发访问带来的锁竞争和额外的`CPU`资源消耗问题。
* 通过引用计数器及时地释放不再被引用的对象，细粒度的内存管理降低了`GC`的频率，减少频繁`GC`带来的时延增大和`CPU`损耗。

###### 可靠性
* 链路有效性检测
<br>由于长连接不需要每次发送消息都创建链路，也不需要在消息完成交互时关闭链路，因此相对于短连接性能更高。为了保证长连接的链路有效性，往往需要通过心跳机制周期性地进行链路检测。
<br><br>使用心跳机制的原因是，避免在系统空闲时因网络闪断而断开连接，之后又遇到海量业务冲击导致消息积压无法处理。为了解决这个问题，需要周期性地对链路进行有效性检测，一旦发现问题，可以及时关闭链路，重建`TCP`连接。
<br><br>为了支持心跳，`Netty`提供了两种链路空闲检测机制：
  * 读空闲超时机制：连续`T`周期没有消息可读时，发送心跳消息，进行链路检测。如果连续`N`个周期没有读取到心跳消息，可以主动关闭链路，重建连接。
  * 写空闲超时机制：连续`T`周期没有消息需要发送时，发送心跳消息，进行链路检测。如果连续`N`个周期没有读取对方发回的心跳消息，可以主动关闭链路，重建连接。
<br><br>为了满足不同用户场景的心跳定制，`Netty`提供了空闲状态检测事件通知机制，用户可以订阅空闲超时事件、写空闲超时事件、读或写超时事件，在接收到对应的
空闲事件之后，灵活进行定制。

* 内存保护机制
<br>`Netty`提供多种机制对内存进行保护，包括以下几个方面：
  * 通过对象引用计数器对`ByteBuf`等内置对象进行细粒度的内存申请和释放，对非法的对象引用进行检测和保护。
  * 通过内存池来重用`ByteBuf`，节省内存。
  * 优雅停机：当系统推出时，`JVM`通过注册的`Shutdown Hook`拦截到退出信号量，然后执行推出操作，释放相关模块的资源占用，将缓冲区的消息处理完成或清空，将待刷新的数据持久化到磁盘和数据库中，等到资源回收和缓冲区消息处理完成之后，再退出。

###### 可定制性
* 责任链模式：`ChannelPipeline`基于责任链模式开发，便于业务逻辑的拦截、定制和扩展。
* 基于接口的开发：关键的类库都提供了接口或抽象类，便于用户自定义实现。
* 提供大量的工厂类，通过重载这些工厂类，可以按需创建出用户需要的对象。
* 提供大量系统参数供用户按需设置，增强系统的场景定制性。

###### 可扩展性
基于Netty的基础NIO框架，可以方便地进行应用层协议定制，例如`Http`协议栈、`Thrift`协议栈、`FTP`协议栈等等。
目前，业界存在大量的基于Netty框架开发的协议，例如`Dubbo`协议，`RocketMQ`内部私有协议。
